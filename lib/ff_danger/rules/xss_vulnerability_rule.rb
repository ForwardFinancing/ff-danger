# frozen_string_literal: true

require_relative './rule'
require 'active_support/core_ext/object/blank'

module FfDanger
  class XssVulnerabilityRule < FfDanger::Rule
    def check!
      detect_potential_xss_vulnerabilities
    end

    private

    def detect_potential_xss_vulnerabilities
      changed_files_matching(/(\.(e)?rb|\.haml|\.jsx)/).each do |path|
        lines_from_file(path).each do |line|
          if line.content =~ /(\s+raw\b|\.html_safe)/
            message(potential_xss_vulnerability_message, file: path, line: line.number)
          end
        end
      end
    end

    def potential_xss_vulnerability_message
      "Looks like you made use of either `<%= raw ... %>`, `.html_safe` which can lead to cross-site scripting vulnerabilities."
    end
  end
end
